
<div style="height: 520px;overflow-y:scroll;overflow-x:None;">
    <div class="rf-container-fluid">
        {#if header}
            <datalist id="LinkSampleTable">
                {#each header as col, colNumber}
                    <option>{col}</option>
                {/each}
            </datalist>
            <div class="rf-grid-row">
                {#each header as col, colNumber}
                    <div
                        class="rf-col rf-padding-4px"
                        draggable={true}
                        on:dragstart={event => dragstart(event, col)}
                    >
                        <div class="rf-tile">
                            <table
                                class="rf-table rf-table--narrow rf-table--striped"
                                class:rf-inactive={!(mapping && mapping.direct && mapping.direct[col])}
                            >
                                <tbody>
                                    <tr>
                                        <th
                                        >{col}</th>
                                    </tr>
                                    {#each displayRows as row, rowNumber}
                                        <tr class="rf-text--sm">
                                            <td
                                                title={row[colNumber]}
                                            >{row[colNumber]}</td>
                                        </tr>
                                    {/each}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>
</div>

<script>
    import { onMount } from 'svelte';
    import { linkFile, resultsPerPage, linkStep, linkSourceHeader, linkSourceHeaderTypes, linkOptions } from '../tools/stores.js';
    import yaml from 'yamljs';

    export let potentialSeparators = [';',',','|','\t'];
    export let potentialQuotes = ["'",'"'];
    export let sep;
    export let quote;
    export let page = 1;
    export let pageSize=5;
    let mapping;
    export let fields;
    export let skipLines;
    export let encoding;
    export let type = 'csv';
    let rows;
    let header;
    let displayRows;

    const guessBoost = {
        city: 3,
        firstName: 3,
        lastName: 2
    }

    $: if (fields) {
        const tmp = {
            direct: {},
            reverse: {}
        };
        fields.filter(f => f.mapTo).map(f => {
            tmp.direct[f.mapTo]=f.field && (f.field.result || f.field);
            tmp.reverse[f.field && (f.field.query || f.field)]=f.mapTo;
        });
        mapping = tmp;
    };

    const locationCodeRegex = /^\d[0-9a-b]\d{3}/;
    const corsicaLocationCodeRegex = /^2[a-b]\d{3}/;
    const postalCodeRegex = /^\d[0-9a-b]\d{3}/;

    const specificLocationCodesMatrix = [[1001,88],[1092,7],[1101,8],[1111,7],[1121,8],[1133,6],[1141,8],[1151,8],[1162,7],[1171,18],[1191,8],[1202,7],[1211,8],[1224,5],[1231,8],[1241,8],[1252,7],[1261,8],[1272,7],[1281,8],[1291,8],[1301,8],[1311,8],[1321,8],[1331,8],[1342,7],[1351,8],[1361,8],[1371,8],[1381,8],[1391,8],[1401,7],[1411,8],[1421,8],[1431,8],[1441,8],[1451,6],[2001,98],[2101,8],[2111,8],[2121,8],[2131,8],[2141,8],[2151,8],[2162,7],[2171,18],[2191,8],[2201,8],[2211,8],[2221,8],[2231,8],[2241,8],[2251,8],[2261,8],[2271,18],[2291,8],[2302,7],[2311,8],[2321,8],[2331,8],[2341,8],[2351,8],[2361,8],[2371,8],[2381,8],[2391,8],[2401,8],[2411,8],[2421,8],[2431,8],[2441,8],[2451,8],[2461,8],[2471,7],[2481,8],[2491,8],[2501,8],[2511,8],[2521,18],[2541,8],[2551,18],[2571,8],[2581,8],[2591,8],[2601,8],[2612,7],[2621,8],[2631,8],[2641,8],[2651,17],[2671,8],[2681,8],[2691,8],[2701,18],[2721,38],[2761,28],[2791,8],[2801,8],[2812,7],[2821,8],[2831,3],[3001,98],[3101,8],[3111,8],[3121,8],[3131,8],[3141,8],[3151,8],[3161,8],[3171,18],[3191,7],[3201,8],[3211,8],[3221,8],[3231,8],[3241,8],[3251,8],[3261,8],[3271,18],[3291,8],[3301,8],[3311,8],[3321,0],[4001,98],[4101,8],[4111,7],[4121,8],[4132,7],[4141,8],[4151,8],[4161,8],[4171,8],[4181,8],[4191,8],[4201,8],[4211,8],[4222,7],[4231,6],[4241,4],[5001,98],[5101,8],[5111,8],[5121,8],[5131,8],[5142,7],[5151,8],[5161,8],[5171,13],[6001,98],[6101,8],[6111,18],[6131,8],[6141,8],[6151,8],[6161,2],[7001,98],[7101,8],[7111,8],[7121,8],[7131,8],[7141,8],[7151,8],[7161,8],[7171,18],[7191,8],[7201,8],[7211,8],[7221,8],[7231,8],[7241,8],[7251,8],[7261,8],[7272,17],[7291,8],[7301,8],[7311,8],[7321,8],[7331,8],[7341,8],[8001,88],[8092,17],[8111,8],[8121,7],[8131,8],[8141,8],[8151,8],[8161,8],[8171,18],[8191,8],[8201,8],[8211,8],[8222,7],[8232,7],[8242,7],[8251,8],[8262,7],[8271,18],[8291,7],[8301,8],[8311,8],[8321,8],[8331,18],[8351,7],[8361,8],[8372,7],[8381,8],[8391,8],[8401,8],[8411,18],[8431,8],[8444,5],[8451,8],[8461,38],[8501,2],[9001,98],[9101,8],[9111,8],[9121,8],[9131,8],[9141,18],[9161,28],[9192,7],[9201,8],[9211,8],[9221,8],[9231,8],[9241,8],[9251,18],[9271,18],[9291,8],[9301,8],[9311,8],[9321,8],[9331,8],[9341,1],[10002,97],[10101,8],[10111,8],[10121,8],[10131,8],[10141,8],[10151,8],[10161,8],[10171,8],[10181,8],[10191,8],[10201,8],[10211,8],[10221,8],[10231,8],[10241,8],[10251,8],[10261,8],[10271,8],[10281,8],[10291,8],[10301,8],[10312,7],[10321,8],[10331,8],[10341,8],[10351,8],[10361,8],[10371,8],[10381,8],[10391,8],[10401,8],[10411,8],[10421,8],[10431,8],[10441,4],[11001,98],[11101,8],[11111,8],[11121,8],[11131,8],[11141,8],[11151,8],[11161,8],[11172,17],[11191,8],[11201,8],[11211,8],[11221,8],[11231,8],[11241,8],[11251,8],[11261,8],[11271,18],[11291,8],[11301,8],[11311,8],[11321,7],[11331,8],[11341,7],[11351,8],[11361,8],[11371,8],[11381,8],[11391,8],[11401,8],[11411,8],[11421,8],[11431,8],[11441,0],[12001,98],[12101,8],[12111,8],[12121,8],[12131,8],[12141,8],[12151,8],[12161,8],[12171,18],[12191,8],[12201,8],[12211,8],[12221,8],[12231,8],[12241,8],[12251,8],[12261,8],[12272,17],[12291,8],[12301,6],[13017,62],[13081,8],[13091,8],[13101,1],[13106,2],[14001,97],[14101,6],[14116,0],[14118,1],[14122,0],[14124,3],[14131,7],[14141,8],[14159,0],[14161,8],[14171,13],[14191,7],[14202,7],[14211,7],[14221,8],[14231,8],[14241,8],[14251,7],[14261,8],[14271,7],[14281,8],[14291,18],[14311,8],[14322,7],[14332,6],[14341,8],[14352,6],[14362,7],[14371,8],[14381,8],[14391,8],[14401,8],[14411,8],[14421,6],[14431,8],[14445,4],[14452,6],[14461,8],[14473,5],[14482,6],[14491,8],[14501,8],[14511,8],[14522,7],[14531,7],[14541,6],[14552,17],[14571,18],[14591,7],[14601,8],[14613,6],[14621,6],[14635,4],[14643,6],[14651,18],[14672,7],[14681,8],[14692,7],[14701,8],[14711,17],[14731,8],[14741,7],[14751,8],[14761,3],[15001,97],[15101,7],[15111,8],[15121,8],[15131,8],[15141,8],[15151,8],[15161,8],[15172,17],[15191,8],[15201,8],[15211,8],[15221,8],[15231,7],[15241,8],[15251,8],[15261,8],[16001,98],[16101,8],[16111,8],[16121,7],[16131,8],[16141,7],[16151,7],[16161,8],[16171,18],[16191,8],[16203,6],[16211,7],[16221,8],[16231,8],[16241,8],[16251,7],[16261,8],[16271,18],[16291,7],[16301,7],[16312,6],[16321,8],[16331,8],[16341,8],[16351,8],[16361,8],[16372,7],[16381,8],[16392,7],[16401,8],[16412,7],[16421,4],[17002,97],[17101,8],[17112,0],[17114,5],[17121,1],[17124,5],[17131,0],[17141,8],[17151,8],[17161,7],[17171,8],[17181,7],[17191,8],[17201,8],[17211,8],[17221,8],[17231,8],[17241,8],[17252,7],[17261,8],[17271,18],[17291,8],[17301,8],[17311,8],[17321,8],[17331,8],[17341,8],[17351,8],[17361,8],[17372,7],[17381,8],[17391,7],[17401,8],[17411,7],[17421,8],[17431,8],[17441,8],[17451,8],[17461,8],[17471,8],[17481,5],[18001,98],[18101,8],[18111,8],[18121,8],[18131,8],[18141,8],[18151,8],[18161,8],[18171,18],[18191,8],[18201,8],[18211,8],[18221,8],[18231,7],[18241,8],[18251,8],[18261,8],[18271,18],[19001,98],[19101,8],[19111,8],[19121,8],[19131,8],[19141,8],[19151,8],[19161,8],[19171,18],[19191,8],[19201,8],[19211,8],[19221,8],[19231,8],[19241,8],[19251,8],[19261,8],[19271,18],[21001,108],[21111,8],[21122,7],[21131,8],[21141,8],[21151,8],[21161,8],[21171,18],[21191,8],[21201,8],[21211,8],[21221,8],[21231,8],[21241,8],[21251,8],[21261,8],[21271,18],[21291,8],[21301,8],[21311,8],[21321,8],[21331,8],[21341,8],[21351,8],[21361,8],[21371,8],[21381,8],[21391,8],[21401,8],[21411,8],[21421,8],[21431,8],[21441,8],[21451,8],[21461,8],[21471,18],[21491,8],[21501,7],[21511,8],[21521,8],[21531,8],[21541,8],[21552,7],[21561,8],[21571,8],[21581,8],[21591,8],[21601,8],[21611,18],[21631,8],[21641,48],[21691,8],[21701,16],[22001,98],[22101,8],[22111,8],[22121,8],[22131,8],[22141,8],[22152,6],[22161,8],[22171,18],[22193,6],[22201,8],[22211,8],[22221,8],[22231,8],[22241,8],[22251,8],[22261,8],[22271,18],[22291,8],[22302,7],[22311,8],[22321,7],[22331,8],[22341,8],[22351,8],[22361,8],[22371,8],[22381,8],[22391,0],[23001,98],[23101,8],[23111,8],[23122,7],[23131,8],[23141,8],[23151,8],[23162,7],[23171,18],[23191,8],[23201,8],[23211,8],[23221,8],[23232,7],[23241,8],[23251,8],[23261,5],[24001,97],[24101,8],[24111,8],[24121,8],[24131,8],[24141,7],[24151,8],[24161,7],[24171,18],[24191,8],[24202,7],[24211,7],[24221,8],[24231,7],[24241,7],[24251,8],[24261,8],[24271,18],[24291,8],[24301,8],[24311,8],[24321,8],[24331,8],[24341,8],[24351,8],[24361,6],[24371,8],[24381,7],[24392,7],[24401,8],[24411,8],[24421,8],[24432,6],[24441,8],[24451,8],[24461,7],[24471,8],[24481,8],[24491,8],[24501,8],[24511,8],[24521,8],[24531,7],[24541,8],[24551,8],[24562,7],[24571,6],[24581,6],[25001,108],[25112,0],[25114,0],[25116,3],[25121,8],[25131,8],[25141,8],[25151,8],[25161,5],[25171,18],[25191,8],[25201,8],[25211,8],[25221,8],[25231,8],[25241,8],[25251,8],[25261,8],[25271,18],[25293,6],[25301,8],[25311,7],[25321,8],[25331,8],[25341,8],[25351,8],[25361,8],[25371,8],[25381,8],[25391,7],[25401,7],[25411,8],[25421,8],[25431,8],[25441,8],[25451,8],[25461,8],[25471,8],[25481,8],[25491,8],[25501,7],[25511,8],[25521,8],[25532,17],[25551,8],[25561,8],[25571,8],[25582,17],[25601,8],[25611,8],[25621,8],[25631,4],[26001,98],[26101,7],[26111,8],[26121,8],[26131,8],[26141,8],[26152,7],[26161,8],[26171,18],[26191,8],[26201,8],[26211,8],[26221,8],[26231,8],[26241,8],[26251,8],[26261,8],[26271,18],[26291,8],[26301,8],[26311,8],[26321,8],[26331,8],[26341,8],[26351,28],[26381,1],[27001,98],[27101,8],[27111,8],[27123,6],[27132,7],[27141,8],[27151,7],[27161,8],[27171,8],[27181,8],[27191,8],[27201,8],[27212,7],[27222,7],[27231,8],[27241,8],[27251,8],[27261,8],[27271,18],[27291,8],[27301,8],[27311,8],[27321,8],[27331,8],[27341,8],[27351,8],[27361,8],[27371,8],[27381,8],[27391,8],[27401,7],[27411,8],[27421,8],[27431,8],[27441,7],[27451,8],[27462,7],[27471,7],[27481,8],[27492,6],[27501,7],[27511,7],[27521,8],[27531,8],[27541,7],[27552,6],[27561,8],[27571,8],[27582,7],[27591,8],[27601,8],[27611,7],[27621,8],[27631,7],[27641,8],[27652,7],[27661,8],[27671,8],[27681,8],[27691,8],[27701,0],[28001,98],[28102,7],[28111,8],[28121,8],[28132,7],[28141,8],[28151,8],[28161,8],[28171,18],[28191,8],[28201,8],[28211,8],[28221,8],[28231,8],[28242,7],[28251,8],[28261,8],[28271,18],[28291,8],[28301,8],[28312,7],[28321,8],[28331,8],[28341,8],[28351,8],[28362,17],[28382,16],[28401,8],[28411,15],[29001,98],[29101,18],[29122,17],[29141,7],[29151,8],[29161,8],[29171,8],[29181,8],[29191,8],[29201,15],[29218,14],[29234,5],[29243,2],[29247,2],[29251,0],[29254,3],[29261,8],[29271,8],[29281,8],[29291,8],[29301,1],[2,0],[30001,98],[30101,8],[30112,1],[30115,4],[30123,0],[30134,5],[30141,8],[30151,8],[30161,8],[30171,18],[30191,8],[30201,8],[30211,8],[30221,8],[30231,8],[30241,8],[30251,8],[30261,8],[30271,18],[30291,8],[30301,8],[30311,8],[30321,8],[30331,8],[30341,8],[30351,5],[31001,98],[31101,8],[31111,8],[31121,8],[31131,8],[31141,8],[31151,8],[31161,8],[31171,8],[31181,8],[31191,8],[31201,8],[31211,8],[31221,8],[31231,8],[31241,8],[31251,8],[31261,8],[31271,8],[31281,8],[31291,8],[31301,8],[31311,8],[31321,8],[31331,8],[31341,8],[31351,8],[31361,8],[31371,8],[31381,8],[31391,8],[31401,8],[31411,8],[31421,8],[31431,8],[31441,8],[31451,8],[31461,8],[31471,8],[31481,8],[31491,8],[31501,8],[31511,8],[31521,8],[31531,8],[31541,8],[31551,8],[31561,8],[31571,8],[31581,8],[31591,2],[32001,98],[32101,8],[32111,8],[32121,8],[32131,8],[32141,8],[32151,8],[32161,8],[32171,18],[32191,8],[32201,18],[32221,8],[32231,8],[32241,8],[32251,7],[32261,8],[32271,18],[32291,8],[32301,8],[32311,8],[32321,8],[32331,8],[32341,8],[32351,8],[32361,8],[32371,8],[32381,8],[32391,8],[32401,8],[32411,8],[32421,8],[32431,8],[32441,8],[32451,8],[32461,7],[33001,88],[33093,6],[33101,8],[33111,0],[33116,3],[33122,0],[33128,1],[33131,1],[33134,3],[33139,0],[33142,7],[33151,8],[33161,2],[33165,4],[33171,8],[33181,3],[33186,3],[33191,8],[33201,8],[33211,8],[33221,8],[33231,8],[33241,8],[33251,8],[33261,8],[33271,18],[33291,8],[33301,8],[33311,8],[33321,8],[33331,8],[33341,8],[33351,8],[33361,8],[33372,7],[33381,8],[33391,8],[33401,8],[33411,8],[33421,8],[33431,8],[33441,8],[33451,8],[33461,7],[33471,8],[33481,8],[33491,8],[33501,8],[33511,8],[33521,8],[33531,8],[33541,8],[33551,4],[34001,68],[34071,8],[34081,8],[34091,18],[34111,8],[34121,8],[34131,8],[34141,8],[34151,8],[34161,8],[34171,18],[34191,8],[34201,8],[34211,8],[34221,8],[34231,8],[34241,8],[34251,8],[34261,8],[34271,8],[34281,8],[34291,3],[34296,3],[34301,8],[34311,8],[34321,8],[34331,8],[34341,3],[35001,109],[35112,0],[35115,4],[35121,7],[35138,1],[35141,8],[35151,8],[35161,8],[35171,18],[35191,8],[35201,7],[35211,8],[35221,8],[35231,3],[35236,3],[35241,8],[35251,8],[35261,7],[35271,18],[35291,8],[35302,7],[35311,8],[35321,8],[35331,8],[35342,5],[35351,8],[35361,2],[36001,98],[36101,8],[36111,8],[36121,8],[36131,8],[36141,8],[36152,7],[36161,8],[36171,8],[36181,8],[36191,8],[36202,7],[36211,8],[36221,8],[36231,8],[36241,7],[37001,98],[37101,8],[37111,8],[37121,8],[37131,8],[37141,8],[37151,8],[37161,8],[37171,18],[37191,8],[37201,7],[37211,8],[37221,8],[37231,7],[37241,8],[37251,8],[37261,8],[37271,11],[38001,68],[38071,7],[38081,8],[38091,8],[38101,8],[38111,0],[38115,2],[38124,5],[38131,2],[38135,2],[38139,0],[38141,0],[38146,3],[38151,8],[38161,8],[38171,8],[38181,8],[38191,8],[38203,6],[38211,8],[38221,8],[38231,8],[38241,8],[38252,7],[38261,8],[38271,8],[38281,8],[38291,8],[38301,18],[38321,8],[38331,8],[38341,8],[38351,8],[38361,8],[38372,7],[38381,8],[38391,8],[38401,8],[38412,7],[38421,8],[38431,8],[38442,7],[38451,8],[38462,7],[38471,8],[38481,8],[38492,7],[38501,8],[38511,8],[38521,8],[38531,8],[38542,7],[38551,8],[38561,6],[39001,98],[39101,8],[39111,8],[39121,8],[39131,8],[39141,8],[39151,8],[39162,7],[39171,18],[39191,8],[39201,8],[39211,8],[39221,8],[39232,7],[39241,8],[39251,8],[39261,8],[39271,18],[39291,8],[39301,7],[39312,7],[39321,8],[39331,18],[39351,8],[39361,7],[39372,7],[39381,18],[39401,8],[39411,47],[39461,38],[39501,18],[39522,47],[39571,15],[40001,88],[40091,8],[40101,8],[40111,8],[40121,8],[40131,8],[40141,8],[40151,8],[40161,8],[40171,8],[40181,8],[40191,8],[40201,8],[40211,8],[40221,8],[40231,8],[40242,7],[40251,8],[40261,8],[40271,8],[40281,8],[40291,8],[40301,8],[40311,8],[40321,8],[40331,3],[41001,98],[41101,8],[41112,7],[41121,8],[41131,8],[41141,8],[41151,8],[41161,7],[41171,18],[41191,8],[41201,8],[41211,8],[41221,8],[41231,8],[41241,8],[41251,8],[41261,8],[41271,18],[41291,6],[42001,98],[42101,8],[42112,1],[42115,4],[42121,0],[42124,5],[42132,7],[42141,8],[42151,0],[42154,0],[42156,3],[42161,8],[42171,18],[42191,18],[42211,8],[42221,8],[42231,8],[42241,18],[42261,8],[42271,18],[42293,6],[42301,7],[42311,8],[42321,8],[42331,8],[43001,98],[43101,8],[43111,8],[43121,8],[43131,8],[43141,8],[43151,8],[43162,7],[43171,18],[43191,8],[43201,7],[43211,8],[43221,8],[43231,8],[43241,8],[43251,8],[43261,7],[44001,98],[44101,8],[44111,3],[44121,8],[44131,8],[44141,8],[44151,8],[44161,8],[44171,18],[44192,7],[44201,8],[44211,7],[44221,3],[45001,98],[45101,8],[45111,8],[45121,8],[45131,8],[45141,8],[45151,8],[45161,8],[45171,18],[45191,8],[45201,8],[45212,7],[45222,7],[45231,8],[45241,8],[45251,8],[45261,8],[45271,18],[45291,8],[45301,8],[45311,6],[45321,8],[45331,8],[45341,7],[46001,88],[46091,7],[46101,8],[46111,8],[46121,8],[46131,8],[46142,7],[46151,8],[46161,8],[46171,18],[46191,8],[46201,8],[46211,8],[46221,8],[46231,8],[46241,8],[46251,8],[46262,7],[46271,28],[46301,8],[46311,8],[46321,8],[46332,7],[47001,108],[47111,8],[47121,8],[47131,8],[47141,7],[47151,8],[47161,8],[47171,8],[47181,8],[47191,8],[47201,8],[47211,8],[47221,8],[47231,8],[47241,8],[47251,8],[47262,7],[47271,18],[47291,8],[47301,8],[47311,8],[47321,7],[48001,98],[48103,5],[48111,8],[48121,8],[48131,8],[48141,8],[48151,7],[48161,8],[48171,17],[48191,7],[49002,67],[49076,0],[49082,17],[49102,7],[49113,1],[49121,0],[49127,2],[49131,7],[49155,0],[49161,6],[49171,17],[49192,27],[49221,7],[49231,6],[49241,7],[49253,6],[49261,8],[49271,7],[49283,5],[49291,8],[49301,7],[49311,0],[49321,8],[49331,8],[49341,6],[49352,7],[49361,8],[49371,7],[49381,0],[50002,97],[50101,8],[50111,7],[50121,8],[50135,4],[50142,7],[50151,8],[50161,8],[50172,6],[50181,7],[50192,7],[50205,4],[50214,5],[50221,8],[50231,8],[50241,6],[50251,8],[50261,8],[50271,18],[50291,8],[50302,3],[50311,6],[50321,7],[50332,6],[50341,8],[50351,8],[50361,8],[50371,8],[50382,7],[50391,8],[50401,8],[50411,8],[50421,8],[50431,6],[50442,6],[50451,6],[50461,8],[50471,8],[50481,8],[50491,8],[50502,7],[50511,8],[50521,8],[50531,8],[50541,8],[50551,5],[50562,7],[50571,8],[50582,7],[50591,8],[50601,8],[50612,7],[50621,8],[50633,6],[50641,7],[51001,98],[51101,8],[51111,8],[51121,8],[51132,7],[51141,8],[51151,7],[51161,8],[51171,17],[51191,8],[51201,7],[51211,8],[51222,7],[51231,8],[51241,8],[51251,8],[51262,7],[51272,17],[51291,8],[51301,8],[51311,8],[51321,8],[51333,6],[51341,8],[51351,8],[51361,8],[51371,8],[51381,8],[51391,8],[51402,17],[51421,8],[51431,18],[51451,8],[51461,8],[51471,8],[51482,7],[51491,8],[51501,8],[51511,8],[51521,8],[51531,68],[51601,62],[52001,98],[52101,8],[52113,6],[52121,8],[52131,7],[52141,8],[52151,8],[52161,8],[52171,18],[52193,6],[52201,7],[52211,8],[52221,8],[52231,6],[52242,7],[52251,7],[52264,5],[52271,18],[52291,7],[52301,7],[52311,8],[52321,7],[52331,6],[52341,18],[52362,7],[52371,28],[52401,6],[52411,88],[52502,48],[53001,98],[53101,8],[53111,8],[53121,18],[53141,7],[53151,7],[53161,8],[53172,17],[53191,8],[53201,8],[53211,8],[53221,8],[53232,7],[53242,7],[53251,8],[53261,8],[53271,5],[54001,98],[54101,8],[54117,0],[54124,4],[54131,2],[54137,2],[54141,8],[54151,8],[54161,8],[54171,8],[54181,8],[54191,8],[54202,4],[54208,1],[54211,8],[54221,8],[54231,8],[54241,8],[54251,8],[54261,8],[54271,8],[54281,8],[54291,8],[54301,8],[54311,7],[54321,8],[54331,8],[54343,6],[54351,8],[54362,7],[54371,8],[54381,2],[54386,3],[54391,8],[54401,8],[54411,8],[54421,3],[54426,3],[54431,8],[54441,8],[54451,8],[54461,8],[54471,8],[54481,8],[54491,8],[54501,8],[54511,8],[54521,8],[54531,8],[54541,8],[54551,8],[54561,8],[54571,8],[54581,8],[54591,8],[54601,1],[55001,98],[55101,8],[55111,8],[55121,8],[55132,7],[55141,8],[55153,6],[55162,7],[55171,18],[55191,8],[55201,7],[55211,8],[55221,8],[55232,7],[55241,7],[55251,7],[55261,8],[55271,18],[55291,8],[55301,6],[55311,6],[55321,78],[55401,28],[55431,67],[55501,85],[56001,98],[56101,8],[56111,8],[56121,8],[56131,8],[56141,8],[56151,8],[56161,8],[56171,18],[56191,8],[56201,18],[56221,8],[56231,8],[56241,8],[56251,8],[56261,3],[57001,48],[57051,18],[57071,28],[57101,18],[57121,8],[57131,8],[57141,8],[57151,3],[57156,3],[57161,8],[57171,3],[57176,3],[57181,2],[57186,3],[57191,8],[57201,18],[57221,8],[57231,8],[57241,3],[57246,3],[57251,3],[57256,3],[57261,8],[57271,7],[57281,8],[57291,8],[57301,8],[57311,8],[57321,8],[57331,8],[57341,8],[57351,8],[57361,3],[57366,2],[57371,8],[57381,3],[57386,3],[57391,8],[57401,3],[57406,3],[57411,0],[57413,1],[57416,3],[57421,7],[57431,8],[57441,3],[57446,3],[57451,3],[57456,3],[57461,8],[57471,8],[57481,8],[57491,8],[57501,8],[57511,3],[57516,3],[57521,3],[57526,3],[57531,3],[57536,3],[57541,8],[57551,8],[57561,3],[57566,3],[57571,8],[57581,8],[57591,8],[57601,18],[57621,8],[57631,3],[57636,3],[57641,3],[57647,2],[57651,3],[57656,3],[57661,8],[57671,8],[57681,3],[57686,3],[57691,7],[57701,8],[57711,8],[57721,7],[57731,8],[57741,26],[58001,108],[58111,8],[58121,8],[58131,8],[58141,8],[58151,8],[58161,8],[58171,8],[58181,8],[58191,8],[58201,8],[58211,8],[58221,8],[58231,8],[58241,8],[58251,8],[58261,8],[58271,18],[58291,8],[58301,8],[58311,2],[59001,98],[59101,8],[59183,0],[59196,1],[59201,8],[59228,0],[59256,1],[59275,1],[59289,0],[59291,0],[59301,8],[59311,8],[59321,8],[59331,9],[59342,7],[59351,8],[59361,8],[59371,8],[59381,8],[59391,8],[59401,8],[59411,8],[59421,8],[59431,8],[59441,8],[59451,8],[59461,8],[59471,8],[59481,8],[59497,2],[59501,8],[59511,8],[59521,8],[59531,8],[59541,8],[59555,4],[59562,7],[59571,8],[59581,8],[59591,8],[59601,8],[59611,8],[59622,7],[59631,8],[59641,8],[59651,8],[59661,8],[60001,98],[60101,8],[60111,0],[60114,2],[60118,0],[60121,1],[60124,1],[60131,2],[60135,2],[60139,0],[60142,6],[60151,1],[60154,0],[60156,0],[60158,1],[60161,0],[60163,6],[60171,1],[60174,0],[60176,3],[60181,8],[60191,8],[60201,8],[60211,8],[60221,8],[60231,8],[60241,8],[60251,8],[60261,8],[60271,8],[60281,8],[60291,8],[60301,8],[60311,8],[60321,8],[60331,8],[60341,7],[60351,8],[60361,8],[60371,8],[60381,8],[60391,8],[60401,8],[60411,7],[60421,8],[60431,8],[60441,18],[60461,18],[60481,8],[60491,8],[60501,8],[60511,8],[60521,8],[60531,8],[60541,8],[60551,8],[60561,8],[60571,8],[60581,8],[60591,8],[60601,8],[60611,8],[60621,18],[60641,7],[60651,8],[60661,18],[60681,8],[60691,8],[60701,2],[61001,98],[61101,7],[61111,7],[61121,8],[61133,6],[61141,8],[61151,8],[61162,7],[61171,18],[61192,7],[61202,7],[61211,8],[61221,8],[61232,6],[61241,7],[61251,8],[61261,8],[61271,18],[61291,7],[61301,8],[61314,5],[61321,8],[61331,8],[61341,8],[61351,7],[61361,8],[61371,8],[61381,8],[61391,8],[61401,7],[61411,8],[61421,8],[61432,7],[61442,6],[61451,16],[61472,16],[61491,8],[61501,11],[62001,98],[62101,8],[62115,0],[62125,0],[62133,0],[62135,0],[62139,0],[62146,0],[62148,0],[62154,0],[62163,0],[62165,4],[62171,0],[62174,0],[62177,1],[62181,0],[62183,1],[62186,0],[62188,1],[62191,4],[62197,1],[62201,8],[62211,3],[62216,0],[62222,0],[62225,4],[62233,6],[62241,8],[62251,8],[62261,8],[62271,8],[62281,8],[62291,8],[62301,8],[62311,8],[62321,8],[62331,8],[62341,8],[62351,8],[62361,8],[62371,8],[62381,8],[62391,8],[62401,8],[62411,8],[62421,8],[62432,7],[62441,8],[62451,8],[62461,8],[62471,8],[62481,8],[62491,8],[62501,8],[62511,8],[62521,8],[62531,8],[62541,8],[62551,8],[62561,8],[62571,3],[62576,3],[62581,8],[62591,8],[62601,8],[62611,8],[62621,8],[62631,8],[62641,8],[62651,8],[62661,8],[62671,8],[62681,8],[62691,8],[62701,8],[62711,8],[62721,8],[62731,8],[62741,8],[62751,8],[62761,8],[62771,8],[62781,8],[62791,8],[62801,8],[62811,8],[62821,8],[62831,8],[62841,8],[62851,8],[62861,8],[62871,8],[62881,8],[62891,18],[63001,98],[63101,8],[63121,0],[63123,6],[63131,8],[63141,8],[63151,8],[63161,8],[63171,18],[63191,8],[63201,8],[63211,8],[63221,8],[63231,8],[63241,8],[63251,8],[63261,8],[63271,18],[63291,8],[63301,8],[63311,8],[63321,8],[63331,8],[63341,8],[63351,8],[63362,7],[63371,8],[63381,8],[63391,8],[63401,8],[63411,8],[63421,8],[63431,8],[63441,8],[63451,8],[63461,8],[63471,2],[64001,21],[64024,75],[64101,8],[64111,8],[64123,6],[64131,8],[64141,8],[64151,8],[64161,7],[64171,18],[64191,8],[64201,8],[64211,8],[64221,8],[64231,8],[64241,8],[64251,8],[64261,8],[64271,18],[64291,8],[64301,8],[64311,8],[64321,8],[64331,8],[64341,8],[64351,8],[64361,8],[64371,18],[64391,8],[64401,8],[64411,8],[64421,8],[64431,8],[64441,8],[64451,8],[64461,8],[64471,8],[64481,8],[64491,8],[64501,8],[64511,8],[64521,8],[64531,28],[65001,98],[65101,8],[65111,8],[65121,8],[65131,8],[65141,8],[65151,18],[65171,18],[65191,8],[65201,18],[65221,8],[65231,8],[65241,8],[65251,8],[65261,8],[65271,18],[65291,8],[65301,8],[65311,8],[65321,8],[65331,18],[65351,8],[65361,8],[65371,8],[65381,8],[65391,8],[65401,8],[65411,8],[65421,8],[65431,8],[65441,18],[65461,21],[66001,98],[66101,8],[66111,8],[66121,8],[66132,7],[66141,8],[66151,8],[66161,8],[66171,8],[66181,8],[66191,8],[66201,8],[66211,8],[66221,7],[66231,3],[67001,98],[67101,8],[67111,0],[67119,0],[67121,8],[67131,8],[67141,8],[67151,8],[67161,8],[67172,17],[67191,8],[67208,1],[67212,6],[67221,8],[67231,8],[67241,8],[67252,7],[67261,8],[67271,8],[67281,8],[67291,8],[67301,8],[67311,8],[67321,8],[67331,8],[67341,8],[67351,8],[67361,8],[67371,8],[67381,8],[67391,7],[67401,8],[67411,7],[67421,8],[67432,6],[67441,8],[67451,8],[67461,7],[67471,8],[67481,8],[67491,8],[67501,8],[67511,8],[67521,8],[67531,8],[67541,7],[67551,8],[68001,38],[68041,58],[68101,8],[68111,4],[68117,0],[68119,0],[68122,1],[68129,0],[68131,8],[68141,8],[68151,8],[68161,8],[68171,8],[68181,8],[68191,8],[68201,8],[68211,8],[68221,8],[68231,8],[68241,8],[68251,8],[68261,8],[68271,8],[68281,8],[68291,8],[68301,8],[68311,7],[68321,8],[68331,7],[68341,8],[68351,8],[68361,7],[68371,8],[68381,5],[69010,89],[69102,7],[69111,2],[69116,3],[69121,2],[69125,0],[69127,0],[69131,8],[69141,8],[69151,8],[69161,8],[69171,18],[69191,8],[69201,8],[69212,7],[69225,4],[69231,8],[69241,8],[69252,7],[69261,8],[69271,8],[69281,8],[69291,8],[70001,98],[70101,8],[70111,8],[70121,8],[70132,6],[70141,8],[70151,8],[70162,7],[70171,8],[70181,8],[70192,7],[70201,7],[70211,8],[70221,8],[70231,8],[70242,7],[70251,18],[70271,8],[70282,7],[70291,8],[70301,8],[70311,8],[70321,38],[70361,38],[70401,38],[70441,58],[70501,82],[71001,98],[71101,8],[71111,6],[71119,0],[71121,8],[71131,8],[71141,8],[71151,8],[71161,8],[71171,18],[71191,8],[71201,8],[71212,7],[71221,8],[71231,8],[71241,8],[71251,8],[71261,8],[71271,18],[71291,8],[71301,8],[71311,8],[71321,8],[71331,8],[71341,8],[71351,8],[71361,8],[71371,8],[71381,8],[71391,8],[71401,8],[71411,8],[71421,7],[71431,8],[71441,8],[71451,8],[71461,8],[71471,8],[71481,8],[71491,8],[71501,8],[71512,7],[71521,8],[71531,8],[71541,8],[71551,17],[71571,8],[71581,8],[71591,0],[72001,98],[72101,8],[72111,8],[72121,8],[72131,8],[72141,8],[72151,7],[72161,8],[72171,18],[72191,8],[72201,8],[72211,8],[72221,8],[72231,8],[72241,8],[72251,8],[72261,8],[72271,18],[72291,8],[72302,7],[72311,8],[72321,8],[72331,8],[72341,8],[72351,8],[72361,8],[72372,7],[72381,5],[73001,98],[73101,8],[73113,6],[73121,8],[73131,8],[73141,8],[73151,8],[73161,7],[73171,18],[73191,6],[73201,7],[73211,8],[73221,8],[73231,6],[73241,8],[73252,7],[73261,8],[73271,18],[73292,7],[73301,8],[73311,7],[73322,7],[74001,98],[74101,8],[74111,8],[74121,8],[74131,8],[74141,7],[74151,8],[74161,8],[74171,18],[74191,8],[74201,8],[74211,8],[74221,8],[74231,8],[74241,8],[74252,7],[74261,8],[74271,18],[74291,8],[74301,8],[74311,4],[75056,0],[76001,98],[76101,8],[76112,0],[76114,1],[76118,0],[76121,8],[76131,1],[76134,5],[76141,8],[76151,8],[76161,8],[76171,18],[76192,7],[76201,8],[76211,8],[76221,8],[76231,8],[76241,8],[76251,8],[76261,8],[76271,8],[76281,8],[76291,8],[76302,7],[76311,8],[76321,8],[76331,8],[76341,8],[76351,8],[76361,8],[76371,8],[76381,8],[76391,8],[76401,8],[76411,8],[76421,8],[76431,8],[76441,8],[76451,8],[76461,8],[76471,8],[76481,8],[76491,8],[76501,8],[76511,8],[76521,8],[76531,7],[76541,8],[76551,8],[76561,8],[76571,7],[76581,8],[76591,8],[76601,8],[76611,8],[76621,8],[76631,7],[76641,8],[76651,7],[76662,17],[76681,8],[76691,8],[76702,7],[76711,8],[76721,7],[76731,8],[76741,8],[76751,8],[77001,88],[77091,8],[77101,9],[77112,1],[77116,1],[77119,0],[77121,0],[77125,0],[77128,1],[77132,0],[77136,1],[77142,1],[77146,1],[77152,1],[77155,1],[77158,1],[77161,1],[77168,0],[77172,0],[77175,0],[77179,1],[77182,0],[77187,1],[77191,8],[77201,8],[77211,8],[77221,8],[77231,8],[77241,8],[77251,8],[77261,8],[77271,8],[77281,8],[77291,7],[77301,8],[77311,8],[77321,8],[77331,8],[77341,8],[77352,7],[77361,8],[77371,8],[77381,8],[77391,7],[77401,8],[77411,8],[77421,8],[77431,8],[77441,8],[77451,8],[77461,8],[77471,8],[77481,17],[77501,8],[77511,3],[77516,3],[77521,13],[78003,93],[78104,4],[78118,0],[78123,0],[78128,0],[78133,5],[78143,4],[78152,6],[78162,6],[78171,1],[78185,4],[78192,4],[78202,7],[78217,0],[78224,3],[78231,8],[78242,4],[78255,0],[78261,8],[78276,2],[78281,8],[78291,8],[78302,5],[78311,6],[78321,8],[78334,3],[78343,6],[78354,4],[78361,7],[78372,0],[78381,8],[78391,7],[78401,6],[78413,5],[78423,0],[78431,8],[78442,2],[78451,4],[78464,2],[78472,6],[78481,5],[78497,2],[78501,5],[78513,5],[78522,6],[78531,6],[78545,3],[78551,8],[78561,8],[78571,5],[78586,2],[78591,6],[78601,8],[78615,3],[78621,3],[78638,0],[78642,5],[78653,2],[78668,0],[78672,5],[78681,7],[79001,95],[79101,8],[79111,8],[79121,8],[79131,8],[79141,8],[79152,7],[79161,6],[79172,7],[79183,6],[79191,7],[79201,8],[79212,6],[79223,6],[79231,8],[79241,8],[79251,8],[79263,6],[79271,18],[79293,6],[79301,8],[79311,8],[79322,7],[79331,8],[79341,8],[79351,6],[80001,78],[80081,8],[80092,7],[80101,8],[80112,2],[80116,1],[80119,0],[80121,0],[80123,6],[80133,0],[80137,2],[80141,8],[80151,8],[80161,8],[80171,18],[80191,8],[80201,7],[80211,8],[80221,8],[80231,8],[80241,8],[80251,8],[80261,8],[80271,17],[80291,8],[80301,7],[80311,8],[80321,8],[80331,8],[80341,8],[80351,8],[80361,8],[80371,17],[80391,8],[80401,8],[80411,7],[80421,8],[80431,8],[80442,7],[80451,8],[80461,8],[80472,7],[80481,8],[80491,8],[80501,8],[80511,8],[80521,17],[80541,8],[80552,7],[80561,8],[80571,8],[80582,17],[80601,8],[80611,8],[80621,8],[80631,8],[80642,7],[80651,18],[80671,8],[80681,7],[80691,8],[80701,8],[80711,27],[80741,8],[80751,18],[80771,8],[80781,18],[80801,18],[80821,8],[80832,4],[81001,88],[81092,7],[81101,8],[81111,8],[81121,8],[81131,8],[81141,8],[81151,8],[81161,8],[81171,18],[81191,8],[81201,8],[81211,8],[81221,8],[81231,8],[81242,7],[81251,8],[81261,8],[81271,18],[81291,8],[81302,7],[81311,8],[81321,5],[82001,98],[82101,8],[82111,8],[82121,8],[82131,8],[82141,8],[82151,8],[82161,8],[82171,18],[82191,4],[83001,98],[83101,8],[83112,6],[83121,8],[83132,3],[83137,2],[83141,1],[83144,4],[83151,3],[84001,98],[84101,8],[84111,8],[84121,8],[84131,8],[84141,8],[84151,0],[85001,98],[85101,8],[85111,8],[85121,8],[85131,8],[85141,8],[85151,8],[85161,8],[85171,8],[85181,8],[85191,8],[85201,8],[85211,7],[85221,8],[85231,8],[85242,6],[85251,8],[85261,8],[85271,7],[85281,8],[85291,7],[85301,6],[86001,98],[86102,7],[86111,8],[86121,8],[86131,8],[86141,8],[86151,8],[86161,8],[86171,7],[86181,8],[86191,7],[86201,8],[86211,7],[86221,8],[86231,8],[86241,8],[86252,6],[86261,8],[86271,8],[86281,8],[86291,8],[87001,98],[87101,8],[87111,8],[87121,8],[87131,8],[87141,8],[87151,8],[87161,8],[87172,17],[87191,8],[87201,5],[88001,98],[88101,8],[88111,8],[88121,8],[88131,8],[88141,8],[88151,8],[88161,8],[88171,18],[88192,7],[88201,8],[88212,7],[88221,8],[88231,8],[88241,8],[88251,8],[88261,8],[88271,18],[88291,8],[88301,8],[88311,8],[88321,7],[88331,7],[88341,8],[88351,8],[88361,8],[88371,8],[88381,8],[88391,8],[88401,8],[88411,8],[88421,8],[88431,8],[88441,8],[88451,8],[88461,8],[88471,8],[88481,8],[88491,8],[88501,8],[88511,8],[88521,8],[88531,1],[89002,97],[89101,7],[89111,1],[89115,0],[89117,2],[89122,7],[89131,8],[89141,2],[89145,4],[89151,8],[89161,8],[89171,18],[89191,8],[89201,8],[89211,8],[89221,8],[89232,7],[89242,7],[89251,8],[89261,7],[89271,18],[89291,8],[89302,7],[89311,8],[89321,8],[89331,8],[89341,8],[89351,8],[89361,18],[89382,6],[89391,8],[89402,7],[89411,8],[89422,6],[89431,8],[89441,8],[89451,8],[89461,8],[89471,8],[89481,5],[90001,98],[90101,4],[91001,68],[91075,4],[91081,5],[91093,6],[91103,12],[91121,8],[91131,6],[91145,3],[91156,3],[91161,0],[91174,5],[91184,2],[91191,7],[91201,6],[91215,1],[91223,5],[91232,3],[91243,6],[91272,3],[91284,2],[91292,2],[91312,7],[91326,0],[91332,7],[91345,2],[91359,0],[91363,0],[91374,4],[91386,0],[91393,6],[91405,3],[91411,3],[91421,4],[91432,3],[91441,0],[91457,1],[91461,8],[91471,8],[91482,0],[91494,14],[91511,8],[91521,5],[91533,5],[91544,5],[91552,4],[91568,0],[91573,6],[91581,8],[91593,6],[91602,0],[91613,6],[91629,0],[91631,8],[91645,4],[91654,5],[91661,6],[91671,8],[91685,4],[91691,1],[92002,76],[93001,78],[94001,80],[95002,92],[95101,1],[95116,3],[95127,0],[95134,5],[95141,8],[95151,6],[95166,3],[95176,1],[95181,2],[95197,2],[95203,2],[95211,8],[95229,0],[95241,0],[95252,6],[95268,0],[95271,6],[95282,6],[95295,3],[95301,8],[95313,3],[95323,5],[95331,0],[95341,7],[95351,4],[95365,4],[95371,8],[95387,1],[95392,3],[95409,0],[95422,7],[95436,2],[95445,2],[95452,7],[95462,0],[95476,0],[95483,6],[95491,2],[95504,5],[95523,6],[95535,4],[95541,2],[95554,1],[95563,3],[95572,2],[95582,3],[95592,6],[95604,3],[95611,1],[95625,3],[95633,4],[95641,0],[95651,7],[95675,3],[95682,0],[97101,8],[97124,0],[97132,0],[97201,9],[97219,0],[97301,8],[97352,1],[97357,1],[97361,1],[97401,8],[97415,0],[97501,1],[97601,13],[97616,1],[97701,1200]];

    let specificLocationCodes = [];

    specificLocationCodesMatrix.forEach(v => {
        for (let i = 0; i < v[1]; i++) {
            specificLocationCodes.push(v[0]+i);
        }
    });

    const specificPostalCodes = [1090,1100,1110,1130,1140,1150,1160,1170,1190,1200,1210,1230,1240,1250,1260,1280,1290,1310,1320,1330,1350,1360,1370,1380,1390,1400,1410,1420,1430,1450,2100,2110,2120,2130,2140,2150,2160,2170,2190,2200,2210,2220,2230,2240,2250,2260,2270,2290,2310,2320,2330,2340,2350,2360,2370,2380,2390,2400,2410,2420,2430,2440,2450,2460,2470,2480,2490,2500,2510,2520,2540,2550,2570,2580,2590,2600,2610,2620,2640,2650,2670,2680,2690,2720,2760,2790,2800,2810,2820,2830,3100,3110,3120,3130,3140,3150,3160,3170,3190,3200,3210,3220,3230,3240,3250,3260,3270,3290,3300,3310,3320,4110,4120,4130,4140,4150,4160,4170,4180,4190,4200,4210,4220,4230,4240,5100,5110,5130,5140,5160,5170,6100,6110,6130,6140,6150,6160,7100,7110,7120,7130,7140,7150,7160,7170,7190,7200,7210,7220,7230,7240,7250,7260,7270,7290,7300,7310,7330,7340,8090,8110,8120,8130,8140,8150,8160,8170,8190,8200,8210,8220,8230,8240,8250,8260,8300,8310,8320,8330,8350,8360,8370,8380,8390,8400,8410,8430,8440,8450,8460,8500,9100,9110,9120,9130,9140,9160,9190,9200,9210,9220,9230,9240,9250,9270,9290,9300,9310,9320,9330,9340,10100,10110,10120,10130,10140,10150,10160,10170,10180,10190,10200,10210,10220,10230,10240,10250,10260,10270,10280,10290,10300,10310,10320,10330,10340,10350,10360,10370,10380,10390,10400,10410,10420,10430,10440,11100,11110,11120,11130,11140,11150,11160,11170,11190,11200,11210,11220,11230,11240,11250,11260,11270,11290,11300,11310,11320,11330,11340,11350,11360,11370,11380,11390,11400,11410,11420,11430,11440,12100,12110,12120,12130,12140,12150,12160,12170,12190,12200,12210,12220,12230,12240,12250,12260,12270,12290,12300,13080,13090,13100,14100,14117,14123,14130,14140,14150,14160,14190,14200,14220,14230,14240,14250,14260,14270,14280,14290,14310,14320,14360,14370,14380,14390,14400,14410,14430,14460,14480,14500,14510,14520,14530,14540,14550,14570,14590,14610,14620,14630,14640,14650,14680,14700,14710,14740,14760,15100,15110,15120,15130,15140,15160,15170,15190,15200,15220,15230,15240,15250,15260,16100,16110,16120,16130,16140,16150,16160,16170,16190,16200,16210,16220,16230,16240,16250,16260,16270,16290,16300,16310,16320,16330,16340,16350,16360,16370,16380,16390,16400,16420,17100,17113,17120,17130,17150,17160,17180,17190,17200,17210,17220,17230,17240,17250,17260,17270,17290,17300,17310,17320,17330,17340,17350,17360,17380,17390,17400,17410,17420,17430,17440,17450,17460,17470,17480,18100,18110,18120,18130,18140,18150,18160,18170,18190,18200,18210,18220,18230,18240,18250,18260,18270,18290,19100,19110,19120,19130,19140,19150,19160,19170,19190,19200,19210,19220,19230,19240,19250,19260,19270,21110,21130,21140,21150,21160,21170,21190,21200,21210,21220,21230,21240,21250,21260,21270,21290,21300,21310,21320,21330,21340,21350,21360,21370,21380,21390,21400,21410,21420,21430,21440,21450,21460,21470,21490,21500,21510,21520,21530,21540,21550,21560,21570,21580,21590,21600,21610,21630,21640,21690,21700,22110,22140,22150,22160,22170,22190,22200,22210,22220,22240,22250,22260,22300,22310,22320,22330,22340,22350,22360,22370,22380,22390,23100,23110,23120,23130,23140,23150,23160,23170,23190,23200,23210,23220,23230,23240,23250,23260,24100,24110,24120,24130,24140,24150,24160,24190,24200,24210,24220,24230,24240,24260,24290,24300,24320,24330,24340,24350,24360,24370,24380,24390,24410,24420,24450,24460,24470,24480,24490,24500,24510,24520,24540,24550,24560,24570,24580,25113,25115,25120,25130,25150,25160,25170,25190,25200,25210,25220,25230,25240,25270,25290,25300,25310,25320,25330,25340,25350,25360,25370,25380,25390,25400,25410,25420,25430,25440,25450,25460,25470,25490,25500,25510,25520,25550,25560,25570,25580,25600,25620,25630,26100,26110,26130,26140,26150,26160,26170,26190,26200,26210,26220,26240,26250,26270,26290,26300,26310,26320,26330,26340,26350,26380,27100,27110,27120,27130,27140,27170,27180,27190,27200,27210,27220,27230,27240,27260,27290,27300,27310,27320,27330,27340,27350,27360,27370,27380,27390,27400,27410,27420,27430,27440,27460,27470,27480,27490,27500,27520,27530,27540,27550,27560,27570,27580,27590,27610,27620,27630,27640,27650,27660,27670,27680,27690,27700,28100,28110,28120,28130,28140,28160,28170,28190,28200,28210,28220,28230,28240,28260,28270,28290,28300,28310,28330,28350,28360,28380,28400,28410,29100,29120,29140,29150,29160,29170,29180,29190,29217,29233,29246,29250,29252,29270,29280,29290,29300,30100,30114,30140,30150,30160,30170,30200,30210,30220,30230,30240,30250,30260,30270,30290,30300,30310,30320,30330,30340,30350,31100,31110,31120,31130,31140,31150,31160,31170,31180,31190,31200,31210,31220,31230,31240,31250,31260,31270,31280,31290,31300,31310,31320,31330,31340,31350,31360,31370,31380,31390,31400,31410,31420,31430,31440,31450,31460,31470,31480,31490,31500,31510,31520,31530,31540,31550,31560,31570,31580,31590,32100,32110,32120,32130,32140,32150,32160,32170,32190,32200,32220,32230,32240,32250,32260,32270,32290,32300,32310,32320,32330,32340,32350,32360,32370,32380,32390,32400,32410,32420,32430,32440,32450,32460,33090,33100,33130,33133,33138,33150,33160,33164,33170,33180,33185,33190,33200,33210,33220,33230,33240,33250,33260,33270,33290,33300,33310,33320,33330,33350,33360,33370,33380,33390,33400,33420,33440,33450,33460,33470,33480,33490,33500,33510,33520,33530,33540,33550,34070,34080,34090,34110,34120,34130,34140,34150,34160,34170,34190,34200,34210,34220,34230,34240,34250,34260,34270,34280,34290,34295,34300,34310,34320,34340,35111,35114,35120,35140,35150,35160,35170,35190,35200,35210,35220,35230,35235,35240,35250,35260,35270,35290,35300,35310,35320,35330,35340,35350,35360,36100,36110,36120,36130,36140,36150,36160,36170,36180,36190,36200,36210,36220,36230,36240,37100,37110,37130,37140,37150,37160,37170,37190,37200,37210,37220,37230,37240,37250,37260,37270,38070,38080,38090,38100,38110,38118,38120,38130,38134,38138,38140,38144,38150,38160,38170,38180,38190,38200,38210,38230,38240,38250,38260,38270,38280,38290,38300,38320,38330,38340,38350,38360,38370,38380,38390,38400,38410,38420,38430,38440,38450,38460,38470,38480,38490,38500,38520,38530,38540,38550,38560,39100,39110,39120,39130,39140,39150,39160,39170,39190,39200,39210,39220,39230,39240,39250,39270,39290,39300,39310,39320,39330,39350,39360,39370,39380,39400,39460,39500,39520,39570,40090,40100,40110,40120,40130,40140,40150,40160,40170,40180,40190,40200,40210,40220,40230,40240,40250,40260,40270,40280,40290,40300,40310,40320,40330,41100,41110,41120,41130,41140,41150,41160,41190,41200,41220,41230,41250,41260,41290,42100,42110,42120,42140,42150,42155,42160,42170,42210,42220,42230,42240,42260,42270,42290,42300,42310,42320,42330,43100,43110,43120,43130,43140,43150,43160,43170,43190,43200,43210,43220,43230,43240,43250,43260,44100,44110,44130,44140,44150,44170,44190,44200,44210,44220,45100,45110,45120,45130,45150,45160,45170,45200,45210,45220,45230,45240,45250,45260,45270,45290,45300,45310,45320,45330,45340,46090,46100,46120,46130,46140,46160,46170,46190,46200,46210,46220,46230,46240,46250,46260,46270,46310,46320,46330,46340,47110,47120,47130,47140,47150,47160,47170,47180,47190,47200,47210,47220,47230,47240,47250,47260,47290,47300,47310,47320,48100,48110,48130,48140,48150,48160,48170,48190,49070,49080,49100,49120,49123,49125,49130,49140,49160,49170,49220,49240,49260,49310,49330,49370,50110,50120,50130,50150,50190,50200,50210,50230,50240,50260,50270,50290,50300,50310,50340,50350,50360,50370,50390,50400,50410,50420,50430,50450,50480,50490,50500,50510,50540,50550,50570,50580,50590,50610,51100,51110,51120,51130,51140,51150,51160,51170,51190,51200,51210,51220,51230,51240,51250,51260,51270,51290,51300,51310,51320,51340,51350,51360,51370,51380,51390,51420,51430,51450,51460,51470,51480,51490,51500,51510,51520,51530,51600,52110,52120,52130,52140,52160,52170,52190,52200,52220,52230,52240,52250,52260,52290,52300,52310,52320,52330,52360,52370,52400,52500,53100,53110,53120,53140,53150,53160,53170,53190,53200,53210,53220,53230,53240,53250,53260,53270,54100,54140,54150,54160,54170,54180,54190,54207,54210,54220,54230,54240,54250,54260,54270,54280,54290,54300,54310,54320,54330,54340,54350,54360,54370,54380,54385,54390,54400,54410,54420,54425,54430,54440,54450,54460,54470,54480,54490,54500,54510,54520,54530,54540,54550,54560,54570,54580,54590,54600,55100,55110,55120,55140,55150,55160,55170,55200,55210,55220,55250,55260,55270,55290,55300,55310,55320,55400,55430,55500,56100,56110,56120,56130,56140,56160,56170,56190,56200,56220,56230,56240,56250,56260,57050,57070,57100,57120,57130,57140,57150,57155,57160,57175,57180,57190,57200,57220,57230,57240,57245,57250,57255,57260,57270,57280,57290,57300,57310,57320,57330,57340,57350,57360,57365,57370,57380,57385,57390,57405,57410,57412,57415,57430,57440,57445,57455,57460,57470,57480,57490,57500,57510,57515,57520,57525,57530,57535,57540,57550,57560,57565,57570,57580,57590,57600,57620,57630,57635,57640,57645,57650,57655,57660,57670,57680,57685,57690,57700,57720,57730,57740,58110,58120,58130,58140,58150,58160,58170,58180,58190,58200,58210,58220,58230,58240,58250,58260,58270,58290,58300,58310,59100,59290,59310,59320,59330,59341,59350,59360,59370,59390,59400,59410,59420,59430,59440,59450,59470,59480,59500,59520,59530,59560,59570,59580,59590,59600,59610,59620,59630,59640,59650,59660,59670,60100,60110,60117,60123,60134,60138,60153,60155,60157,60160,60162,60170,60173,60175,60180,60190,60200,60210,60220,60230,60240,60250,60260,60270,60280,60290,60310,60320,60330,60340,60350,60360,60370,60380,60390,60400,60410,60420,60430,60440,60460,60480,60490,60500,60510,60520,60530,60540,60550,60560,60570,60590,60600,60610,60620,60640,60650,60660,60680,60700,61100,61120,61130,61140,61150,61160,61170,61190,61210,61230,61240,61260,61290,61300,61310,61330,61350,61360,61370,61390,61400,61420,61440,61450,61490,61500,62100,62134,62147,62164,62170,62182,62185,62187,62190,62196,62215,62240,62250,62260,62270,62280,62290,62300,62310,62320,62330,62340,62350,62360,62370,62380,62390,62400,62410,62430,62440,62450,62460,62470,62480,62490,62500,62510,62520,62530,62540,62550,62560,62570,62580,62590,62600,62610,62620,62630,62640,62650,62660,62670,62680,62690,62700,62710,62720,62730,62740,62750,62760,62770,62780,62790,62800,62810,62820,62830,62840,62850,62860,62870,62880,62890,63100,63122,63130,63140,63150,63160,63170,63190,63200,63210,63220,63230,63240,63250,63260,63270,63290,63300,63310,63320,63330,63340,63350,63360,63370,63380,63390,63400,63410,63420,63430,63440,63450,63460,63470,64023,64100,64110,64130,64140,64150,64160,64170,64190,64200,64210,64220,64230,64240,64250,64260,64270,64290,64300,64310,64320,64330,64340,64350,64360,64370,64390,64400,64410,64420,64430,64440,64450,64460,64470,64480,64490,64500,64510,64520,64530,64560,65100,65110,65120,65130,65140,65150,65170,65190,65200,65220,65230,65240,65250,65260,65270,65290,65300,65310,65320,65330,65350,65360,65370,65380,65390,65400,65410,65420,65430,65440,65460,66100,66120,66130,66140,66150,66160,66170,66180,66190,66210,66220,66230,67100,67110,67120,67130,67140,67150,67160,67190,67210,67220,67230,67240,67250,67260,67270,67280,67290,67300,67310,67320,67330,67340,67350,67360,67370,67380,67400,67410,67420,67430,67440,67450,67460,67470,67480,67490,67500,67510,67520,67530,67540,67550,68040,68100,68110,68116,68118,68130,68140,68150,68160,68170,68180,68190,68200,68210,68230,68240,68250,68260,68270,68280,68290,68300,68320,68330,68340,68350,68360,68370,68380,69100,69110,69115,69120,69124,69126,69130,69140,69160,69170,69190,69200,69220,69230,69240,69250,69260,69270,69280,69290,70100,70120,70130,70140,70150,70160,70170,70180,70190,70200,70210,70220,70230,70240,70250,70280,70290,70310,70320,70360,70400,70440,70500,71100,71110,71118,71120,71130,71140,71150,71160,71170,71190,71200,71210,71220,71230,71240,71250,71270,71290,71300,71310,71320,71330,71340,71350,71360,71370,71380,71390,71400,71410,71420,71430,71440,71450,71460,71470,71480,71490,71500,71510,71520,71530,71540,71550,71570,71580,71590,72100,72110,72120,72130,72150,72160,72170,72190,72200,72210,72220,72230,72250,72260,72270,72290,72300,72310,72320,72330,72340,72350,72360,72370,72380,73100,73110,73120,73130,73140,73150,73160,73170,73190,73200,73210,73220,73230,73240,73250,73270,73290,73300,73310,73320,73330,74100,74130,74140,74150,74160,74170,74190,74200,74210,74220,74240,74250,74260,74290,74310,76100,76113,76130,76133,76140,76160,76170,76190,76200,76210,76220,76230,76240,76250,76260,76270,76280,76290,76300,76320,76330,76340,76350,76360,76370,76380,76390,76400,76410,76420,76430,76440,76450,76460,76470,76480,76490,76500,76510,76520,76530,76540,76550,76560,76570,76580,76590,76600,76610,76620,76630,76640,76650,76660,76680,76690,76700,76710,76720,76730,76740,76750,77090,77100,77111,77118,77120,77154,77157,77167,77169,77171,77181,77190,77200,77210,77220,77230,77240,77250,77260,77270,77280,77290,77300,77310,77320,77330,77340,77350,77360,77370,77380,77390,77400,77410,77420,77430,77440,77450,77460,77470,77480,77500,77510,77515,77520,78113,78117,78120,78140,78160,78190,78220,78230,78290,78300,78310,78320,78350,78380,78410,78420,78440,78460,78470,78490,78520,78530,78550,78590,78620,78640,78650,79100,79120,79130,79140,79150,79160,79170,79180,79190,79200,79210,79220,79230,79250,79270,79290,79300,79310,79320,79340,79350,80080,80090,80100,80110,80115,80118,80120,80122,80140,80150,80160,80170,80190,80200,80210,80220,80230,80240,80250,80260,80270,80290,80300,80310,80320,80330,80340,80350,80360,80390,80400,80410,80420,80430,80440,80450,80460,80470,80480,80490,80500,80520,80540,80550,80560,80570,80580,80600,80620,80630,80640,80650,80670,80680,80690,80700,80710,80740,80750,80770,80780,80800,80820,80830,81090,81100,81110,81120,81130,81140,81150,81160,81170,81190,81200,81210,81220,81230,81240,81250,81270,81290,81300,81310,81320,82100,82110,82120,82130,82140,82150,82160,82170,82190,83100,83136,83140,83143,84100,84110,84120,84130,84140,84150,85100,85110,85120,85130,85140,85160,85190,85200,85210,85220,85240,85250,85260,85280,85290,85300,86100,86110,86120,86130,86140,86150,86160,86170,86180,86190,86200,86210,86220,86230,86250,86260,86270,86280,86290,86300,87100,87110,87120,87130,87140,87150,87160,87170,87190,87200,88100,88110,88120,88130,88140,88150,88160,88170,88190,88200,88210,88220,88230,88240,88250,88260,88270,88290,88300,88310,88320,88330,88340,88350,88360,88370,88380,88390,88400,88410,88430,88440,88450,88460,88470,88480,88490,88500,88510,88520,88530,89100,89113,89116,89120,89130,89144,89150,89160,89170,89190,89200,89210,89220,89230,89240,89250,89270,89290,89300,89310,89320,89350,89360,89380,89390,89400,89410,89420,89430,89440,89450,89460,89470,89480,90100,91080,91100,91130,91180,91200,91240,91330,91340,91390,91540,91560,91570,91600,91630,95110,95120,95150,95170,95210,95250,95270,95280,95370,95430,95450,95480,95500,95510,95580,95610,95660,95680,95690,97356,97360,97615];

    const isLocationCode = (code) => {
        if (!locationCodeRegex.test(code)) {
            return false;
        }
        if (corsicaLocationCodeRegex.test(code)) {
            return true;
        }
        if (specificLocationCodes.includes(parseInt(code))) {
            return true;
        }
        return false;
    };

    const isPostalCode = (code) => {
        if (!postalCodeRegex.test(code)) {
            return false;
        };
        if (specificPostalCodes.includes(parseInt(code))) {
            return true;
        }
        return false;
    };

    const guessTypes = [
        [/^[1-2]\d{3}\/[0-1]\d\/[0-3]\d$/, 'date=yyyy/MM/dd'],
        [/^[1-2]\d{3}-[0-1]\d-[0-3]\d$/, 'date=yyyy-MM-dd'],
        [/^[1-2]\d{3}[0-1]\d[0-3]\d$/, 'date=yyyyMMdd'],
        [/^[0-3]\d-[0-1]\d-[1-2]\d{3}$/, 'date=dd-MM-yyyy'],
        [/^[0-3]\d\/[0-1]\d\/[1-2]\d{3}$/, 'date=dd/MM/yyyy'],
        [/^[0-3]\d[0-1]\d[1-2]\d{3}$/, 'date=ddMMyyyy'],
        [isLocationCode, 'locationCode'],
        [isPostalCode, 'postalCode'],
        [/^[1-2]$/, 'sex=12'],
        [/^[0-1]$/, 'sex=01'],
        [/^(f|m)$/, 'sex=fm'],
        [/^(f|h)$/, 'sex=fh'],
        [/^((0?|[1-9])[0-9a-b]|97[1-5]?|99)$/, 'depCode'],
        [/^(martin|bernard|thomas|petit|robert|richard|durand|dubois|moreau|simon|laurent|garcia|michel|lefebvre|leroy|david|martinez|bertrand|roux|morel|fournier|girard|lambert|dupont|bonnet|rousseau|fontaine|vincent|andre|muller|lefevre|guerin|mercier|faure|garnier|chevalier|blanc|francois|boyer|legrand|gauthier|lopez|perrin|clement|robin|da|morin|sanchez|henry|gautier|nicolas|roussel|masson|mathieu|duval|perez|marchand|denis|marie|noel|dumont|lemaire|lucas|dufour|meyer|blanchard|meunier|fernandez|joly|brun|brunet|riviere|barbier|gerard|giraud|gaillard|leroux|arnaud|vidal|roy|renard|schmitt|colin|roche|caron|rodriguez|roger|picard|pereira|aubert|nguyen|lemoine|fabre|renaud|pierre|olivier|ferreira|dumas|lacroix|leclerc|bourgeois|philippe|dos|benoit|rey|jean|guillaume|rolland|lecomte|leclercq|hubert|louis|payet|guillot|rodrigues|berger|fernandes|carpentier|dupuy|dupuis|moulin|deschamps|gonzalez|goncalves|huet|adam|vasseur|charles|fleury|menard|boucher|poirier|baron|jacquet|aubry|royer|paris|guyot|klein|bertin|renault|maillard|charpentier|carre|herve|gomez|schneider|marty|bailly|collet|le|bouvier|leger|julien|daniel|millet|martins|breton|germain|langlois|cousin|perrot|lebrun|prevost|besson|le|leveque|barre|le|pelletier|remy|weber|leblanc|hamon|marchal|monnier|hernandez|michaud|perrier|boulanger|etienne|tessier|mallet|jacob|guichard|chauvin|gillet|ruiz|collin|poulain|lemaitre|chevallier|antoine|bouchet|diallo|marechal|gay|pons|humbert|delaunay|benard|perret|hoarau|pasquier|da|grondin|gilbert|alexandre|lejeune|cordier|reynaud|briand|lamy|albert|besnard|pichon|georges|barthelemy|lopes|cohen|ollivier|launay|gros|carlier|buisson|charrier|guillou|lesage|voisin|vallee|legros|hebert|delattre|coulon|laporte|rossi|guillet|jacques|didier|marques|gomes|marin|camus|martel|paul|levy|lebreton|blanchet|barbe|bigot|pineau|leduc|ribeiro|navarro|mahe|lelievre|gaudin|pascal|sauvage|maillot|gregoire|coste|joubert|verdier|maury|bodin|bousquet|tanguy|masse|guillon|raynaud|hardy|colas|morvan|allard|alves|raymond|berthelot|delmas|devaux|laine|thibault|delorme|regnier|lebon|lenoir|blondel|courtois|seguin|joseph|valentin|ferrand|chauvet|clerc|bruneau|bonneau|brunel|costa|imbert|allain)$/, 'lastName'],
        [/^(jean|marie|michel|pierre|philippe|alain|andre|claude|bernard|jacques|anne|daniel|christian|dominique|patrick|christophe|nathalie|nicolas|isabelle|gerard|catherine|sylvie|francoise|monique|eric|laurent|frederic|rene|francois|stephane|david|pascal|sebastien|martine|thierry|robert|julien|olivier|roger|christine|jacqueline|nicole|valerie|guy|georges|sandrine|marcel|didier|stephanie|sophie|veronique|marc|paul|mohamed|celine|bruno|alexandre|vincent|chantal|louis|henri|serge|jerome|yves|maria|christiane|thomas|patricia|guillaume|annie|joseph|brigitte|maurice|michele|antoine|helene|franck|gilles|laurence|aurelie|raymond|virginie|corinne|jose|julie|christelle|anthony|romain|emilie|gilbert|cedric|francis|danielle|elodie|caroline|denis|florence|maxime|cecile|joel)((\s*\w+)+)?$/, 'firstName'],
        [/^\s*(paris|marseille|lyon|toulouse|nice|nantes|montpellier|strasbourg|bordeaux|lille|rennes|reims|saint.etienne|havre|toulon|grenoble|dijon|angers|nimes|villeurbanne|saint.denis|aix.en.provence|mans|clermont.ferrand|brest|tours|amiens|limoges|annecy|perpignan|boulogne.billancourt|metz|besanion|orliaans|saint.denis|argenteuil|rouen|mulhouse|montreuil|saint.paul|caen|nancy|tourcoing|roubaix|nanterre|vitry.sur.seine|avignon|criateil|dunkerque|poitiers|aubervilliers|asniires.sur.seine|colombes|versailles|aulnay.sous.bois|saint.pierre|courbevoie|fort.de.france|cherbourg.en.cotentin|rueil.malmaison|champigny.sur.marne|tampon|pau|biaziers|la.rochelle|calais|saint.maur.des.fossias|cannes|antibes|mamoudzou|miarignac|drancy|colmar|saint.nazaire|ajaccio|issy.les.moulineaux|evry|noisy.le.grand|bourges|vianissieux|la.seyne.sur.mer|cergy|levallois.perret|quimper|valence|villeneuve.d.ascq|antony|pessac|ivry.sur.seine|troyes|cayenne|neuilly.sur.seine|montauban|clichy|chambiary|niort|sarcelles|lorient|beauvais|blanc.mesnil)\s*$/, 'city'],
        [/^\s*(france|algerie|maroc|tunisie|italie|portugal|espagne)\s*$/, 'country'],
    ];

    $: if ($linkOptions && $linkOptions.csv &&
        (
            ($linkOptions.csv.sep !== sep) ||
            ($linkOptions.csv.skipLines !== skipLines) ||
            ($linkOptions.csv.quote !== quote) ||
            ($linkOptions.csv.encoding !== encoding)
        )) {
            read($linkOptions.csv);
        }

    $: if ($linkSourceHeader && mapping && rows) {
        header = [
            ...fields.map(f => mapping.reverse && $linkSourceHeader.includes(mapping.reverse[f.field]) && mapping.reverse[f.field])
                .filter(x => x),
            ...$linkSourceHeader.map(h => !(mapping.direct && mapping.direct[h]) && h).filter(x => x)
        ];

        displayRows = rows.slice((page-1)*page,page*pageSize)
            .map(row => header.map(h => row[$linkSourceHeader.indexOf(h)]))
    }

    $: $linkSourceHeader && linkSourceHeaderTypes.update(v => {
        const types = {};
        $linkSourceHeader.forEach(col => {
            types[col] = guessFieldType(rows.map(row => row[$linkSourceHeader.indexOf(col)]))
        });
        return types
    });

    const norm = (s) => {
        return s ? s.normalize('NFKD').replace(/[\u0300-\u036f]/g, "").toLocaleLowerCase() : '';
    }

    const guessFieldType = (column) => {
        const guess = maxFreqTerm(column.map(f => {
            let g = norm(f);
            const dic = {};
            guessTypes.map(r => {
                if (r[0] instanceof RegExp) {
                    if (g.replace(r[0],r[1]) === r[1]) {
                        dic[r[1]] = true;
                    }
                } else {
                    if (r[0](g)) {
                        dic[r[1]] = true;
                    }
                }
            });
            return dic;
        }));
        return guess && {
            type: guess[0].replace(/=.*/,''),
            format: /=/.test(guess[0]) && guess[0].replace(/.*=/, ''),
            freq: guess[1]
        };
    };

    const maxFreqTerm = (a) => {
        let maxCount = 0;
        let maxTerm = undefined;
        let dic = {};
        a.map(d => {
            Object.keys(d).forEach(v => {
                const boost = guessBoost[dic[v]] ? guessBoost[dic[v]] : 1
                dic[v] = dic[v] ? dic[v] + boost : boost;
                if (dic[v] > maxCount) {
                    maxTerm = v;
                    maxCount = dic[v]
                }
            });
        });
        if (maxCount > (a.length / 20)) {
            return [maxTerm, Math.max(1, Math.round(100 * maxCount / Math.max(1, a.length)) / 100)];
        } else {
            return undefined;
        }
    }

    const guessSeparator = (csv) => {
        let max = 0;
        const csvLines = csv.split(/(\r\n|\n\r|\n|\r)/).map(r => r.trim()).filter(r => r);
        const pLines = csvLines.length ? (1/csvLines.length) : 1;
        potentialSeparators.map(c => {
            const dist={};
            csvLines.forEach(r => {
                const m = r.split(c).length;
                if (dist[m]) { dist[m]+=pLines } else { dist[m] = pLines }
            });
            let n = 0;
            let p = 0;
            Object.keys(dist).forEach(m => {if (dist[m]>p) {n = parseInt(m); p = dist[m]}});
            if ((p > 0.5) && (n > max)) { max = n; sep = c; }
        });
        skipLines= 0;
        csvLines.slice(0,10).forEach(r => {
            const m = r.split(sep).length;
            if (m !== max) {
                skipLines++;
            }
        });
    };

    const guessQuote = (csv, sep, skipLines) => {
        let rows;
        if (quote) {potentialQuotes = [quote]}
        potentialQuotes.map(q => {
            const re = new RegExp(`^(${q}(([^${q}]|${q}${q})*?)${q}|([^${protect(sep)}]*))(\\${protect(sep)}(.*))?$`);
            const re2 = new RegExp(`${q}${q}`,'g');
            const quoteCounts = [0, 0];
            rows = csv.split(/(\r\n|\n\r|\n|\r)/).slice(skipLines).map(r => r.trim()).filter(r => r).map(r => {
                const row = [];
                let i = 0;
                while(r !== undefined) {
                    i += 1;
                    const m = r.match(re);
                    if (m) {
                        row.push(m[2] ? m[2].replace(re2, `${q}`) : m[4]);
                        if (m[2]) { quoteCounts[0] += 1}
                        if (m[4]) { quoteCounts[1] += 1}
                        r = m[6];
                    } else {
                        if (r === '') {
                            row.push('');
                        } else {
                            r = undefined;
                        }
                    }
                };
                return row.map(col => col.replace(/^\s*/,'').replace(/\s*$/,'') || '<vide>');
            });
            if (quoteCounts[0] > quoteCounts[1]) {
                quote = q;
            }
        });
        return rows;
    }

    const protect = (sep) => {
        return sep === '|' ? '\|' : sep;
    }

    const guessFileType = (ev) => {
        const contents = ev.target.result;
        if (type === 'gedcom') {
            parseGedcom(contents);
        } else {
           parseCsv(contents);
        }
    }

    const gedcomToYaml = [
        [/(\r\n|\n\r|\r)/mg, '\n'],
        [/^0 /mg,''],
        [/^1 /mg,'  '],
        [/^2 /mg,'    '],
        [/^3 /mg,'      '],
        [/^4 /mg,'        '],
        [/^5 /mg,'          '],
        [/^6 /mg,'            '],
        [/^( *)(\S+) (\S+.*)\n  \1(\S+)/mg,'$1$2\n  $1XXXX $3\n  $1$4'],
        [/^( *)([a-zA-Z_0-9\-\@]+):?/mg, (a,b,c) => {return b+c.toLowerCase()+':'}],
        [/(\@\S+\@)/mg, (a,b) => {return b.toLowerCase()}],
        // simple array
        [/^( *)(\w{4}): *([^\n]+)\n(\1(\2): *([^\n]+)\n)+/mg,(a) => {
            return a.substring(0,a.indexOf(':')+1) + '\n' + a.replace(/( +)\w{4}: +(.*)/mg,'  $1- $2');
        }],
        //complex arrays
        [/^(\s*)(\w{4}):\s*([^\n]*\n(\s+\1[a-zA-Z0-9_\-][^\n]*\n)*)\1(\2):\s*([^\n]*)\n/mg,'$1$2:\n  $1- $3  $1- $6\n'],
        [/^( *)\- *\-/mg,'$1-'],
        [/^( *)\- *([^\n]+\n(  \1[^\- ][^\n]*\n)*)\1(\w[^\n]*)\n/mg,'$1- $2$1  $4\n']
    ];

    const gedcomDatesPattern = /^(((de|entre|between|from)\s)?(((\d{1,2})\s+)?(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\S?\s+)?(\d{4})\s+)?((|et|to|avant|bef|before|aprs|aft|after|autour de|vers|around)\s)?(((\d{1,2})\s+)?(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\S?\s+)?(\d{4})/;

    const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];

    const gedcomDate = (stringDate) => {
        stringDate=`${stringDate}`;
        const parsed = stringDate.match(gedcomDatesPattern);
        if (parsed) {
            const startMonth = `${months.indexOf(parsed[7])+1}`;
            const endMonth = `${months.indexOf(parsed[14])+1}`;
            if (parsed[3]) {
                // range
                stringDate = `${parsed[8]}${startMonth.padStart(2, '0')}${parsed[6]}-${parsed[15]}${endMonth.padStart(2, '0')}${parsed[13]}`;
            } else {
                let limit = '';
                if (['before','bef','avant'].includes(parsed[10])) {
                    limit = '<'
                } else if (['aprs','aft','after'].includes(parsed[10])) {
                    limit = '<'
                }
                stringDate = `${parsed[15]}${endMonth.padStart(2, '0')}${parsed[13]}`;
            }
        }
        return stringDate;
    }

    const parseGedcom = (contents) => {
        if (!(/^0 HEAD/.test(contents))) {
            return false;
        }
        let tree = contents;
        gedcomToYaml.forEach(r => {
            let changed = tree.replace(r[0],r[1]);
            while (changed!==tree) {
                tree = changed;
                changed = tree.replace(r[0],r[1]);
            }
        });
        tree = yaml.parse(tree);
        rows = Object.keys(tree).map(k => {
            if (/^\@i.*\@$/.test(k)) {
                const id = k;
                let firstName = tree[k].surn;
                let lastName = tree[k].givn;
                const name = tree[k].name;
                const normName = name.replace(/^\s*(Mr|Monsieur|Madame|Mme|M\.|Mrs)\s+/gi,'');
                const sex = tree[k].sex;
                if (normName) {
                    if (!firstName) {
                        firstName = normName.replace(/^(.*)\s+\/.*$/,'$1');
                    }
                    if (!lastName) {
                        lastName = name.replace(/^.*\/\s*(.*)\s*\/.*$/,'$1');
                    }
                }
                let birthDate, birthPlace, birthCity, birthCountry, birthDep;
                if (tree[k].birt) {
                    birthDate = tree[k].birt.date ? gedcomDate(tree[k].birt.date) : '';
                    birthPlace = tree[k].birt.plac;
                    if (birthPlace && birthPlace.includes(',')) {
                        birthCity = birthPlace.replace(/^(.*)\s*,.*/,'$1');
                        birthCountry = birthPlace.replace(/^.*,\s*(.*)$/,'$1');
                        birthDep = birthPlace.replace(/.*,\s*(.*)\s*,\.*/,'$1');
                    }
                }
                let deathDate, deathPlace, deathCity, deathCountry, deathDep;
                if (tree[k].deat) {
                    deathDate = tree[k].deat.date ? gedcomDate(tree[k].deat.date) : '';
                    deathPlace = tree[k].deat.plac;
                    if (deathPlace && deathPlace.includes(',')) {
                        deathCity = deathPlace.replace(/^(.*)\s*,.*/,'$1');
                        deathCountry = deathPlace.replace(/^.*,\s*(.*)$/,'$1');
                        deathDep = deathPlace.replace(/.*,\s*(.*)\s*,\.*/,'$1');
                    }
                }
                return [
                    id,lastName,firstName,name, sex,
                    birthDate, birthCity, birthCountry, birthDep, birthPlace,
                    deathDate, deathCity, deathCountry, deathDep, deathPlace,
                ].map(x => x || '');
            }
        }).filter(x => x);
        const myHeader = [
            'gedcom_id','nom','prnom(s)','nom_prnom(s)','sexe',
            'date de naissance', 'ville de naissance','pays de naissance','dpartement de naissance','lieu de naissance',
            'date de dcs', 'ville de dcs','pays de dcs','dpartement de dcs','lieu de dcs'
        ];
        if ((!$linkOptions.csv) && ($linkFile)) {
            $linkOptions.csv = {
                sep: '\t',
                skipLines: 0,
                dateFormat: 'yyyyMMdd',
                encoding: 'utf-8',
                type: type,
                gedcom: tree,
                csv: myHeader.join('\t')+'\n'+rows.map(r => r.join('\t')).join('\n')
            };
            console.log('Guessed type:',$linkOptions.csv);
        }
        $linkSourceHeader = myHeader;
        return true;
    }

    const parseCsv = (contents) => {
        if (!sep) { guessSeparator(contents) }
        rows = guessQuote(contents, sep, skipLines);
        if ((!$linkOptions.csv) && ($linkFile)) {
            $linkOptions.csv = {
                sep: sep,
                quote: quote,
                skipLines: skipLines,
                encoding: encoding,
                type: type
            };
            console.log('Guessed CSV type:',$linkOptions.csv);
        }
        mapping = {};
        $linkSourceHeader = rows.shift();
    };

    const read = async (csvOptions) => {
        let blob = $linkFile.slice(0, 100000);
        if (csvOptions) {
            sep = csvOptions.sep;
            encoding = csvOptions.encoding;
            quote = csvOptions.quote;
            skipLines = csvOptions.skipLines;
        } else {
            const badChars = 'a';
            const potentialEncodings = ['utf8','latin1','windows-1252','mac'];
            let min = 9999;
            await Promise.all(potentialEncodings.map(async enc => {
                const reader = new FileReader();
                reader.readAsText(blob, enc);
                const result = await new Promise((resolve, reject) => {
                    reader.onload = (ev) => {
                        const contents = ev.target.result;
                        if (/^0 HEAD/.test(ev.target.result)) {
                            type = 'gedcom';
                        }
                        resolve(contents.normalize('NFKD').replace(/[\u0300-\u036f]/g, '').toLocaleLowerCase().replace(/\s*/,'').replace(/[\x00-\x7F]*/g,'').length)
                    }
                });
                if (result < min) {
                    encoding = enc;
                    min = result;
                }
            }));
        }
        console.log('type',type)
        const reader = new FileReader();
        reader.readAsText(blob, encoding);
        reader.onload = guessFileType;
    };

	export function dragstart (ev, col) {
		ev.dataTransfer.effectAllowed = 'move';
        ev.dataTransfer.dropEffect = 'move';
        ev.dataTransfer.setData('text/plain', JSON.stringify({
                col: col,
                type: $linkSourceHeaderTypes[col] && $linkSourceHeaderTypes[col].type,
                format: $linkSourceHeaderTypes[col] && $linkSourceHeaderTypes[col].format,
                freq: $linkSourceHeaderTypes[col] && $linkSourceHeaderTypes[col].freq
        }));
    };

    onMount(() => {
        $linkFile && read();
    })

</script>

<style>

  td {
    max-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

</style>
